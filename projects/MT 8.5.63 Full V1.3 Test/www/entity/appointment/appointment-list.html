<!DOCTYPE html>
<html>
<head>
    <!-- Activate IE9 document mode, if available -->
    <meta charset="utf-8" http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- Defined iOS viewport -->
    <meta name="viewport" content="initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=false">
    <!-- Disable iOS Phone No Detection -->
    <meta name="format-detection" content="telephone=no" />
    <!-- DevExtreme dependencies -->
    <script type="text/javascript" src="../../scripts/jquery-3.3.1.min.js"></script>
    <!-- DevExtreme themes -->
    <link rel="stylesheet" type="text/css" href="../../css/dx.common.css" />
    <link rel="stylesheet" type="text/css" href="../../css/dx.light.css" />
    <!-- A DevExtreme library -->
    <script type="text/javascript" src="../../scripts/dx.all.js"></script>
    <!-- Offline HTML JavaScript Bridge-->
    <script type="text/javascript" src="../../scripts/JSBridge.js"></script>
    <script type="text/javascript" src="../../scripts/k2aMethods.js"></script>
    <script type="text/javascript" src="../../enum/Schema.js"></script>
    <script type="text/javascript" src="../../enum/setupoption.js"></script>
    <script type="text/javascript" src="appointment-inspection_jsa.js"></script>
    <!-- Offline HTML Template Factory-->
    <script type="text/javascript" src="../../templates/listItem-factory.js"></script>
    <script type="text/javascript" src="../../templates/toolbar-factory.js"></script>
    <!-- Offline HTML Styling -->
    <link rel="stylesheet" type="text/css" href="../../css/k2a.css" />
    <title>Entity List</title>
</head>
<body>
    <div id="toast"></div>
    <div class="fixedPosition">
        <div id="mainToolbar"></div><br id="toolbarSpace">
        <div id="listToolbar"></div>
        <div id="mainScrollView">
            <div id='mainList'></div>
        </div>
        <div id="actionSheet"></div>
        <div id="filterPopup"></div>
    </div>

    <script>
        //============== INITIAL SETTINGS ================
        var entityName = SCHEMA.appointment.name;
        var isLookupList = false, lookupID = null, lookupAttribute = SCHEMA.appointment.Properties.servicecallid;
        var sortDesc = false, sortSelector = SCHEMA.appointment.Properties.startdate;
        var jsaName = "Job Safety Analysis"
        const ViewLabel = {
            allAppt: "All Appointments",
            newAppt: "New Appointments",
            oldAppt: "Old Appointments",     
            contactedAppt: "Contacted Appointments",
            scheduledAppt: "Scheduled Appointments",
            thisWeekAppt: "This Week Appointments",
            thisMonthAppt: "This Month Appointments",
                               
        };
        var selectedView = ViewLabel.allAppt;
        //============== OFFLINE DATA ================
        var entityListData;
        //============== SELECTED DATA ================
        var selected = { entityName: null, barcode: null };
        //============== FETCH DATA ================
        var requiredSetupOptions = [
            SETUPOPTION.JobSafetyValidationLevel,
            SETUPOPTION.JobSafetyUnsafeStatus,
            SETUPOPTION.OnSiteStatusUpdate,
            SETUPOPTION.ShowTasksForAppointments,
            SETUPOPTION.TimeLogAllowTimeOverlap,
            SETUPOPTION.TimeLogStatusUpdate,
            SETUPOPTION.UseBarcoding,
            SETUPOPTION.UseJobSafetyTasks,
            SETUPOPTION.UseLabor,
            SETUPOPTION.UseMobileAuditBackgroundSync,
            SETUPOPTION.UseSublocationValidation,
            SETUPOPTION.UseTimeLog
        ];
        var entityAttributes = [
            SCHEMA.appointment.Properties.id,
            SCHEMA.appointment.Properties.name,
            SCHEMA.appointment.Properties.appointmentstatusid,
            SCHEMA.appointment.Properties.description,
            SCHEMA.appointment.Properties.estimatehours,
            SCHEMA.appointment.Properties.servicecallid,
            SCHEMA.appointment.Properties.gpappointmenttype,
            SCHEMA.appointment.Properties.locationid,
            SCHEMA.appointment.Properties.startdate,
            SCHEMA.appointment.Properties.technicianactivityid,
            SCHEMA.appointment.Properties.jobsafetydate

        ];
        var listSortItems = [
            SCHEMA.appointment.Properties.startdate
        ];
        var listSearchItems = [
            SCHEMA.appointment.Properties.name,
            SCHEMA.appointment.Properties.startdate,
            SCHEMA.appointment.Properties.estimatehours,
            SCHEMA.appointment.Properties.description,
            SCHEMA.equipment.Properties.barcode,
            SCHEMA.location.name,
            SCHEMA.technicianactivity.name,
            SCHEMA.appointmentstatus.name,
            'call_description'
        ];
        var listFilterItems = [
            { dataField: SCHEMA.appointment.Properties.name, dataType: FilterDataType.string },
            { dataField: SCHEMA.appointment.Properties.startdate, dataType: FilterDataType.date },
            { dataField: SCHEMA.technicianactivity.name, dataType: FilterDataType.string },
            { dataField: SCHEMA.location.name, dataType: FilterDataType.string },
            { dataField: SCHEMA.appointmentstatus.name, dataType: FilterDataType.string },
            { dataField: SCHEMA.appointment.Properties.estimatehours, dataType: FilterDataType.number },
            { dataField: SCHEMA.appointment.Properties.description, dataType: FilterDataType.string },
            { dataField: 'call_description', dataType: FilterDataType.string }
        ];

        var listItemTemplate = function (data, _, element) {
            try {
                var isTechActivity = parseInt(data.gpappointmenttype) === 2;
                var labels = {};
                labels.activity = MobileCRM.Localization.get("activity");
                labels.location = MobileCRM.Localization.get(entityName + "." + SCHEMA.location.name);
                labels.status = MobileCRM.Localization.get(entityName + ".statecode");
                labels.estHours = MobileCRM.Localization.get(entityName + "." + SCHEMA.appointment.Properties.estimatehours);
                labels.description = MobileCRM.Localization.get(entityName + "." + SCHEMA.appointment.Properties.description);
                labels.callDescription = MobileCRM.Localization.get(entityName + ".call_description");

                element.append(
                    $("<span>").append(data.name).css("font-size", "large"),
                    $("<span>").append(formatDateTime(data.startdate)).css("float", "right"),
                    $("<br>"),
                    $("<div>").append(isTechActivity ? labels.activity.toUpperCase() : labels.location.toUpperCase()).addClass('listItemLabel'),
                    $("<div>").append(isTechActivity ? data.technicianactivity : data.location),
                    $("<span>").append(labels.status.toUpperCase() + ": ").addClass('listItemLabel'),
                    $("<span>").append(data.appointmentstatus),
                    $("<span>").append(
                        $("<span>").append(labels.estHours.toUpperCase() + ": ").addClass('listItemLabel').css("margin-left", "10px"),
                        $("<span>").append(formatFloat(data.estimatehours, 2))
                    ).css("float", "right")
                );

                if (data.description && data.description.trim() !== "")
                    element.append(
                        $("<br>"),
                        $("<span>").append(labels.description.toUpperCase() + ": ").addClass('listItemLabel'),
                        $("<span>").append(data.description)
                    );
                if (data.call_description)
                    element.append(
                        $("<br>"),
                        $("<span>").append(labels.callDescription.toUpperCase() + ": ").addClass('listItemLabel'),
                        $("<span>").append(data.call_description)
                    );
            }
            catch (e) { alertError("Template Error:\n" + e); }
        };
        //============== TOOLBAR ITEMS ================
        var mainToolbarItems = [ToolbarItemType.selectView];
        var listToolbarItems = [
            ToolbarItemType.btnSort, ToolbarItemType.selectSort, ToolbarItemType.btnFilter
        ];
        //============== LIST ACTION ITEMS ================
        var actionItems = [
            { text: "More", onClick: editEntity },
            { text: "Complete", onClick: completeAppointment },
        ];

        $(function () {
            //============== LOCALIZATION ================
            MobileCRM.Localization.initialize(function (localization) {

                //============== ANDROID CHECK ================
                MobileCRM.Platform.preventBackButton(btnBackClicked);

                //============== LOADPANEL ================
                loading = MobileCRM.UI.Form.showPleaseWait(MobileCRM.Localization.get("Msg.Loading"));

                //============== SCROLLVIEW ================
                mainScrollView = $("#mainScrollView").dxScrollView({
                    showScrollbar: "always",
                    height: function () { return window.innerHeight - 80; },
                    width: '100%'
                }).dxScrollView("instance");
                $(window).resize(function () {
                    if (!isLookupList)
                        updateToolbarItem(mainToolbar, ToolbarItemType.selectView, 'options', {
                            width: $(window).width() * 0.75,
                            value: selectedView
                        });
                    repaintScrollView(mainScrollView);
                });

                //============== TOOLBARS ================
                mainToolbar = $("#mainToolbar").dxToolbar({}).dxToolbar("instance");
                listToolbar = $("#listToolbar").dxToolbar({
                    items: (new ToolbarFactory()).addItems(listToolbarItems)
                }).dxToolbar("instance");

                //============== LIST ================
                mainList = (new ListFactory()).createItem("#mainList", entityName, [
                    { name: 'searchExpr', value: listSearchItems },
                    { name: 'itemTemplate', value: listItemTemplate }
                ]);

                //============== ACTION SHEETS ================
                actionSheet = (new ActionSheetFactory()).createItem(actionItems, "#actionSheet");

                //============== EVENT HANDLERS ================
                MobileCRM.bridge.onGlobalEvent("EntityFormClosed", function (closedForm) {
                    if (closedForm.entity) {
                        var formEntity = closedForm.entity.entityName;
                        if (formEntity === entityName || formEntity === SCHEMA.timelog.name || formEntity === SCHEMA.laborexpense.name) {
                            fetchListEntityData();

                            if (setupOptions.UseMobileAuditBackgroundSync)
                                mobileAuditBackgroundSync(closedForm.entity);
                        }
                    }
                }, true);
                MobileCRM.Configuration.requestObject(function (config) {
                    MobileCRM.bridge.onGlobalEvent("SyncFinished", fetchListEntityData, !config.settings.requireSyncLogin);
                }, MobileCRM.bridge.alert);
                MobileCRM.bridge.onGlobalEvent("ApptUnsafe", fetchListEntityData, true);

                loadSetupOptions(loadListOptions);
            }, alertError);
        });

        //============== LOAD OPTIONS ================
        function loadListOptions() {
            loadSelectedView(entityName).then(function (view) {
                sortDesc = view && view.desc ? JSON.parse(view.desc) : sortDesc;
                selectedView = view && view.select ? view.select : selectedView;

                MobileCRM.UI.EntityForm.requestObject(function (entityForm) {
                    lookupAttribute = entityForm.entity.entityName + "id";
                    isLookupList = true;
                    lookupID = entityForm.entity.id;
                    loadToolbarOptions();
                    loadListItemOptions();
                    loading.close();
                }, function (err) {
                    loadToolbarOptions();
                    loadListItemOptions();
                    loading.close();
                });
            }, alertError);
        }
        function loadToolbarOptions() {
            if (isLookupList) {
                mainToolbar.option("visible", false);
                $("#toolbarSpace").css("display", "none");
            }
            else {
                mainToolbar.option("items", (new ToolbarFactory()).addItems(mainToolbarItems));
                updateToolbarItem(mainToolbar, ToolbarItemType.selectView, "options", {
                    displayExpr: 'display',
                    valueExpr: 'value',
                    items: [
                        { display: MobileCRM.Localization.getComponentLabel(entityName, "View", ViewLabel.allAppt), value: ViewLabel.allAppt },
                        { display: MobileCRM.Localization.getComponentLabel(entityName, "View", ViewLabel.newAppt), value: ViewLabel.newAppt },
                        { display: MobileCRM.Localization.getComponentLabel(entityName, "View", ViewLabel.oldAppt), value: ViewLabel.oldAppt },
                        { display: MobileCRM.Localization.getComponentLabel(entityName, "View", ViewLabel.contactedAppt), value: ViewLabel.contactedAppt },
                        { display: MobileCRM.Localization.getComponentLabel(entityName, "View", ViewLabel.scheduledAppt), value: ViewLabel.scheduledAppt },
                        { display: MobileCRM.Localization.getComponentLabel(entityName, "View", ViewLabel.thisWeekAppt), value: ViewLabel.thisWeekAppt },
                        { display: MobileCRM.Localization.getComponentLabel(entityName, "View", ViewLabel.thisMonthAppt), value: ViewLabel.thisMonthAppt },
                        
                     ],
                    width: $(window).width() * 0.75,
                    value: selectedView
                });
            }

            if (typeof listFilterItems !== 'undefined' && listFilterItems.length > 0)
                (new FilterFactory()).createFilterPopup(mainList, listToolbar);

            loadSortItemsLocalization(listSortItems).then(function (sortDataSource) {
                updateToolbarItem(listToolbar, ToolbarItemType.selectSort, "options.dataSource", sortDataSource);
                updateToolbarItem(listToolbar, ToolbarItemType.selectSort, "options.value", sortSelector);
            });

            updateToolbarItem(listToolbar, ToolbarItemType.btnSort, "options.icon", sortDesc ? 'arrowdown' : 'arrowup');
        }
        function loadListItemOptions() {
            if (setupOptions.UseBarcoding)
                addBarcodeSearch();

            fetchListEntityData();
        }

        //============== LOAD DATA ================
        function fetchListEntityData() {
            var entity = new MobileCRM.FetchXml.Entity(entityName);
            $(entityAttributes).each(function (index, attribute) {
                entity.addAttribute(attribute);
            });
            entity.orderBy(sortSelector, sortDesc);

            if (isLookupList) {    //Filter: Servicecall Lookup List
                entity.filter = new MobileCRM.FetchXml.Filter();
                entity.filter.where(lookupAttribute, 'eq', lookupID);
            }

            // Link: Location
            var locLink = entity.addLink(
                SCHEMA.location.name,
                SCHEMA.location.Properties.id,
                SCHEMA.appointment.Properties.locationid,
                "outer");
            locLink.addAttribute(SCHEMA.location.Properties.name);
            locLink.alias = SCHEMA.location.name;

            // Link: Service Call
            var callLink = entity.addLink(
                SCHEMA.servicecall.name,
                SCHEMA.servicecall.Properties.id,
                SCHEMA.appointment.Properties.servicecallid,
                "outer");
            callLink.addAttribute(SCHEMA.servicecall.Properties.description);
            callLink.alias = 'call';

            // Link: Technician Activity
            var techActivityLink = entity.addLink(
                SCHEMA.technicianactivity.name,
                SCHEMA.technicianactivity.Properties.id,
                SCHEMA.appointment.Properties.technicianactivityid,
                "outer");
            techActivityLink.addAttribute(SCHEMA.technicianactivity.Properties.name);
            techActivityLink.alias = SCHEMA.technicianactivity.name;

            // Link: Appointment Status
            var apptStatusLink = entity.addLink(
                SCHEMA.appointmentstatus.name,
                SCHEMA.appointmentstatus.Properties.id,
                SCHEMA.appointment.Properties.appointmentstatusid,
                "inner");
            apptStatusLink.addAttribute(SCHEMA.appointmentstatus.Properties.name);
            apptStatusLink.alias = SCHEMA.appointmentstatus.name;
            apptStatusLink.addFilter().notIn(SCHEMA.appointmentstatus.Properties.name, ['COMPLETE', 'RE-ASSIGN']);

            var fetch = new MobileCRM.FetchXml.Fetch(entity);
            fetch.execute("DynamicEntities", function (res) {
                // Note: for filter to work with date attributes have to fetch DynamicEntities
                // To work with res as JSON then set each value to properties
                $(res).each(function (i, value) {
                    res[i] = value.properties;
                });

                // For list search to work can not have "." in attribute name
                $(res).each(function (i, _) {
                    if (res[i][locLink.alias + '.name'])
                        res[i][locLink.alias] = res[i][locLink.alias + '.name'];
                    if (res[i][callLink.alias + '.description'])
                        res[i][callLink.alias + '_description'] = res[i][callLink.alias + '.description'];
                    if (res[i][techActivityLink.alias + ".name"])
                        res[i][techActivityLink.alias] = res[i][techActivityLink.alias + ".name"];
                    if (res[i][apptStatusLink.alias + ".name"])
                        res[i][apptStatusLink.alias] = res[i][apptStatusLink.alias + ".name"];

                });
                entityListData = res;

                addBarcodeSearchAttributes().then(function () {
                    loadListEntityData();
                    loading.close();
                }, alertError);
            }, alertError);
        }
        function addBarcodeSearchAttributes() {
            var deferred = $.Deferred();

            var fetchPromises = [fetchEquipmentBarcodesByServicecallid()];

            if (setupOptions.UseSublocationValidation) {
                fetchPromises.push(fetchSublocationBarcodesByServicecallid());
            }

            $.when.apply($, fetchPromises).then(function () {
                var equipmentBarcodes = arguments[0];
                var sublocationBarcodes = arguments[1] ? arguments[1] : null;

                for (var callid in equipmentBarcodes) {
                    var filteredData = new DevExpress.data.DataSource({
                        store: entityListData,
                        filter: [SCHEMA.appointment.Properties.servicecallid, '=', callid],
                        paginate: false
                    });

                    filteredData.load().done(function (apptData) {
                        $(apptData).each(function (_, appt) {
                            appt.barcode = equipmentBarcodes[callid];
                        })
                    });
                }

                for (var callid in sublocationBarcodes) {
                    var filteredData = new DevExpress.data.DataSource({
                        store: entityListData,
                        filter: [SCHEMA.appointment.Properties.servicecallid, '=', callid],
                        paginate: false
                    });

                    filteredData.load().done(function (apptData) {
                        $(apptData).each(function (_, appt) {
                            appt.barcode += sublocationBarcodes[callid];
                        })
                    });
                }

                return deferred.resolve();
            }, function (err) { return deferred.reject(err); });
            return deferred.promise();
        }
        function fetchEquipmentBarcodesByServicecallid() {
            var deferred = $.Deferred();
            var entity = new MobileCRM.FetchXml.Entity(SCHEMA.task.name);
            entity.addAttribute(SCHEMA.task.Properties.servicecallid);

            // Barcode Search--> Link: Task Equipment Barcode
            var equipLink = entity.addLink(
                SCHEMA.equipment.name,
                SCHEMA.equipment.Properties.id,
                SCHEMA.task.Properties.equipmentid,
                "inner");
            equipLink.addAttribute(SCHEMA.equipment.Properties.barcode);
            equipLink.alias = 'e';

            equipLink.addFilter().where(SCHEMA.equipment.Properties.barcode, 'not-null');
            equipLink.addFilter().where(SCHEMA.equipment.Properties.barcode, 'ne', '');
            equipLink.filter.type = 'and';

            var fetch = new MobileCRM.FetchXml.Fetch(entity);
            fetch.execute("JSON", function (res) {
                var barcodes = {};

                $(res).each(function (i, task) {
                    barcodes[task.servicecallid] = task[equipLink.alias + "." + SCHEMA.equipment.Properties.barcode];
                });

                return deferred.resolve(barcodes);
            }, function (err) { return deferred.reject("Fetch Equipment Barcodes Error:\n" + err); });
            return deferred.promise();
        }
        function fetchSublocationBarcodesByServicecallid() {
            var deferred = $.Deferred();
            var entity = new MobileCRM.FetchXml.Entity(SCHEMA.task.name);
            entity.addAttribute(SCHEMA.task.Properties.servicecallid);

            // Barcode Search--> Link: Task Equipment Sublocation Barcode
            var equipLink = entity.addLink(
                SCHEMA.equipment.name,
                SCHEMA.equipment.Properties.id,
                SCHEMA.task.Properties.equipmentid,
                "inner");
            var sublocationLink = equipLink.addLink(
                SCHEMA.sublocation.name,
                SCHEMA.sublocation.Properties.id,
                SCHEMA.equipment.Properties.sublocationid,
                "inner");
            sublocationLink.addAttribute(SCHEMA.sublocation.Properties.barcode);
            sublocationLink.alias = 'sl';

            sublocationLink.addFilter().where(SCHEMA.sublocation.Properties.barcode, 'not-null');
            sublocationLink.addFilter().where(SCHEMA.sublocation.Properties.barcode, 'ne', '');
            sublocationLink.filter.type = 'and';

            var fetch = new MobileCRM.FetchXml.Fetch(entity);
            fetch.execute("JSON", function (res) {
                var barcodes = {};

                $(res).each(function (i, task) {
                    barcodes[task.servicecallid] = task[sublocationLink.alias + "." + SCHEMA.sublocation.Properties.barcode];
                });

                return deferred.resolve(barcodes);
            }, function (err) { return deferred.reject("Fetch Equipment Barcodes Error:\n" + err); });
            return deferred.promise();
        }

        function loadListEntityData() {
            if (isLookupList)
                loadListData(mainList, entityListData);
            else
                loadApptTypeFilteredData();
        }
        
        function loadApptTypeFilteredData() {
            var apptType;
            switch (selectedView) {
                case ViewLabel.jobAppt:         apptType = 3; break;
                case ViewLabel.serviceAppt:     apptType = 1; break;
                case ViewLabel.techActivity:    apptType = 2; break;
                default:                        apptType = 0;
            }

            var filteredData = new DevExpress.data.DataSource({
                store: entityListData,
                paginate: false
            });
            if (apptType > 0)
                filteredData.filter([SCHEMA.appointment.Properties.gpappointmenttype, '=', apptType]);

            if (selectedView == ViewLabel.newAppt)
                {
				filteredData.filter([
				[ SCHEMA.appointmentstatus.name, "<>", "CONTACTED" ],
				"and",
				[ SCHEMA.appointmentstatus.name, "<>", "SCHEDULED" ]
				]);
				
                }

            if (selectedView == ViewLabel.contactedAppt)
				{
				filteredData.filter([SCHEMA.appointmentstatus.name, '=', "CONTACTED"]);
				}

			if (selectedView == ViewLabel.scheduledAppt)
				{
				filteredData.filter([SCHEMA.appointmentstatus.name, '=', "SCHEDULED"]);
				}

		    if (selectedView == ViewLabel.thisWeekAppt)
				{
				let curr = new Date;
			
				let week = [];
				for (let i = 1; i <= 8; i++) {
				  let first = curr.getDate() - curr.getDay() + i - 1;
				  let day = new Date(curr.setDate(first));
				  week.push(day.setHours(0,0,0,0));
				}
		
		       
				filteredData.filter([
				[ SCHEMA.appointment.Properties.startdate, ">=", week[0] ],
				"and",
				[ SCHEMA.appointment.Properties.startdate, "<", week[7] ]
				]);		
            }


			if (selectedView == ViewLabel.thisMonthAppt)
				{
				var monthdate = new Date();
				var firstDay = new Date(monthdate.getFullYear(), monthdate.getMonth(), 1)
				var lastDay = new Date(monthdate.getFullYear(), monthdate.getMonth() + 1, 0)
				filteredData.filter([
				[ SCHEMA.appointment.Properties.startdate, ">=", firstDay ],
				"and",
				[ SCHEMA.appointment.Properties.startdate, "<=", lastDay ]
				]);

				}

			if (selectedView == ViewLabel.oldAppt)
				{
				filteredData.filter([SCHEMA.appointment.Properties.startdate, '<=', Date.now()]);
				}
                           
            filteredData.load().done(function (data) {
                loadListData(mainList, data);
                loading.close();
            });
        }
        //============== TOOLBAR FUNCTIONS ================
        function btnSortClicked() {
            updateSelectedView(entityName, { desc: sortDesc, select: selectedView })
                .then(loadListEntityData, MobileCRM.bridge.alert);
        }
        function sortSelected() {
            btnSortClicked();
        }
        function viewSelected(e) {
            if (selectedView != e.selectedItem.value) {
                selectedView = e.selectedItem.value;
                updateSelectedView(entityName, { desc: sortDesc, select: selectedView })
                    .then(loadApptTypeFilteredData, MobileCRM.bridge.alert);
            }
        }
        function barcodeScanned(barcode) {
            var filteredListData = new DevExpress.data.DataSource({
                store: entityListData,
                filter: [SCHEMA.equipment.Properties.barcode, 'contains', barcode],
                paginate: false
            });
            filteredListData.load().done(function (res) {
                mainList.option("searchValue", barcode);
                if (res.length === 1) {
                    // Only 1 barcode result, navigate to linked entity
                    var tabToSelect = (typeof res[0]['t.barcode'] !== 'undefined') ? SCHEMA.task.name : SCHEMA.equipment.name;

                    if (isLookupList)
                        MobileCRM.UI.EntityForm.requestObject(function (entityForm) {
                            if (entityForm.entity.entityName === SCHEMA.servicecall.name)
                                entityForm.selectTab(tabToSelect);
                        }, MobileCRM.bridge.alert);
                    else {
                        if (tabToSelect === SCHEMA.task.name && setupOptions.ShowTasksForAppointments && parseInt(res[0].gpappointmenttype) === 1) {
                            selected[entityName] = res[0];
                            selected.barcode = barcode;
                            completeAppointment();
                        }
                        else {
                            MobileCRM.UI.FormManager.showEditDialog(SCHEMA.servicecall.name, res[0].servicecallid.id, null,
                                { iFrameOptions: { barcode: barcode, selectTab: tabToSelect } });
                        }
                    }
                }
                else // No or multiple barcode results
                    mainList.option("searchValue", barcode);
            });
        }

        //============== LIST ITEM FUNCTIONS ================
        function listItemClicked() {
            if (setupOptions.UseLabor && setupOptions.UseTimeLog) {
                var entity = new MobileCRM.FetchXml.Entity(SCHEMA.timelog.name);
                entity.addAttribute(SCHEMA.timelog.Properties.id);
                entity.addAttribute(SCHEMA.timelog.Properties.gptimein);
                entity.addAttribute(SCHEMA.timelog.Properties.gptimeout);
                entity.filter = new MobileCRM.FetchXml.Filter();
                entity.filter.where(SCHEMA.timelog.Properties.appointmentid, 'eq', selected[entityName].id);

                var fetch = new MobileCRM.FetchXml.Fetch(entity);
                fetch.execute("JSON", function (res) {
                    if (res.length > 0) {
                        var isTimeIn = true;
                        for (var i in res) {
                            if (res[i].gptimein && !res[i].gptimeout) {
                                // Time Out
                                selected.timelog = res[i];
                                isTimeIn = false;
                                break;
                            }
                        }
                        addActionSheetItem(isTimeIn, showActionSheet);
                    }
                    else // Time In
                        addActionSheetItem(true, showActionSheet);
                }, alertError);
            }
            else
                showActionSheet();
        }
        function addActionSheetItem(isTimeIn, callback) {
            var timelogItem = isTimeIn ?
                { text: "Time In", onClick: timeIn, type: 'default' } :
                { text: "Time Out", onClick: timeOut, type: 'default' };
            var cancelItem = { text: "Cancel", type: 'default', mode: 'outlined', onClick: function () { actionSheet.hide(); } };
            var updatedActionItems = [actionItems[0], actionItems[1], timelogItem, cancelItem];

            actionSheet.option("dataSource", updatedActionItems);
            callback();
        }
        function showActionSheet() {
            actionSheet.option({
                title: MobileCRM.Localization.get(entityName) + ": " + selected[entityName].name,
                visible: true
            });
        }

        //============== LIST EXECUTIONS ================
        function editEntity() {
            MobileCRM.bridge.raiseGlobalEvent("CloseApptForm", {
                entityID: selected[entityName].id,
                formType: "COMPLETE"
            });
            MobileCRM.UI.FormManager.showEditDialog(entityName, selected[entityName].id, null, { iFrameOptions: {} });
        }
        function completeAppointment() {
            MobileCRM.DynamicEntity.loadById(SCHEMA.appointment.name, selected[entityName].id, function (appt) {
                selected[entityName] = appt.properties;
                MobileCRM.Configuration.requestObject(function (config) {
                    if (parseInt(selected[entityName].gpappointmenttype) === 2) {
                        if (config.isBackgroundSync)
                            sayLocalization("Alert.CantSaveWhileSync");
                        else
                            checkOpenTimeLog().then(function (hasOpenTimeLog) {
                                var msg = hasOpenTimeLog ? "Alert.ExistingTimeInForActivity" : "Alert.CompleteMessage";

                                var popup = new MobileCRM.UI.MessageBox(MobileCRM.Localization.get(msg));
                                popup.items = [MobileCRM.Localization.get("enum.Yes"), MobileCRM.Localization.get("enum.No")];
                                popup.show(function (btn) {
                                    if (btn === MobileCRM.Localization.get("enum.Yes")) {
                                        if (hasOpenTimeLog)
                                            timeOut();
                                        else {
                                            if (setupOptions.UseLabor) {
                                                checkForLaborExpense().then(function (hasLaborExpense) {
                                                    if (!hasLaborExpense) {
                                                        var target = new MobileCRM.Reference(entityName, selected[entityName].id);
                                                        var relationship = new MobileCRM.Relationship(SCHEMA.laborexpense.Properties.appointmentid, target);
                                                        MobileCRM.UI.FormManager.showNewDialog(SCHEMA.laborexpense.name, relationship, {
                                                            "@initialize": {
                                                                transactiontype: "UNBILLED", costtype: 1, transactionstatus: 1,
                                                                hoursunits: selected[entityName].estimatehours ? parseFloat(selected[entityName].estimatehours) : 0,
                                                                transactiondate: selected[entityName].startdate ? selected[entityName].startdate : new Date()
                                                            }
                                                        });
                                                    }
                                                    else {
                                                        completeTechActivity();
                                                    }
                                                }, MobileCRM.bridge.alert);
                                            }
                                            else {
                                                completeTechActivity();
                                            }
                                        }
                                    }
                                    return;
                                });
                            }, MobileCRM.bridge.alert);
                    }
                    else if (selected[entityName].name.toUpperCase().indexOf("PENDING") > -1) {
                        sayLocalization("Alert.SyncCompleteAppointment");
                    }
                    else if (setupOptions.UseJobSafetyTasks && setupOptions.JobSafetyUnsafeStatus && selected[entityName].appointmentstatusid &&
                        selected[entityName].appointmentstatusid.primaryName.indexOf(setupOptions.JobSafetyUnsafeStatus) > -1) {
                        sayLocalization("Alert.AppointmentStatusUnsafe");
                    }
                    else if (parseInt(selected[entityName].gpappointmenttype) === 1 && setupOptions.UseJobSafetyTasks
                        && parseInt(setupOptions.JobSafetyValidationLevel) === 2 // Required
                        && (!selected[entityName].jobsafetydate || (new Date(selected[entityName].jobsafetydate)).getFullYear() <= 1900)) {
                        checkUseInspections().then(function (useInspections) {
                            if (useInspections) {
                                showJSAQuestionnaire(appt);
                            }
                            else {
                                sayLocalization("Alert.CompleteJSReport");
                            }
                        }, alertError);
                    }
                    else if (config.isBackgroundSync) {
                        sayLocalization("Alert.CantSaveWhileSync");
                    }
                    else {
                        MobileCRM.bridge.raiseGlobalEvent("CloseApptForm", {
                            entityID: selected[entityName].id,
                            formType: "DEFAULT"
                        });

                        var target = new MobileCRM.Reference(SCHEMA.appointmentcompletion.name, null);
                        var relationship = new MobileCRM.Relationship(SCHEMA.appointmentcompletion.Properties.regardingobjectid, target);
                        var options = selected.barcode ? { barcode: selected.barcode, selectTab: SCHEMA.task.name } : {};

                        MobileCRM.UI.FormManager.showEditDialog(
                            entityName,
                            selected[entityName].id,
                            relationship,
                            { iFrameOptions: options }
                        );
                    }
                    selected.barcode = null;
                }, MobileCRM.bridge.alert);
            }, MobileCRM.bridge.alert);
        }
        function completeTechActivity() {
            fetchCompleteStatus().then(function (completeStatusID) {
                MobileCRM.DynamicEntity.loadById(entityName, selected[entityName].id, function (res) {
                    res.properties.appointmentstatusid = new MobileCRM.DynamicEntity(SCHEMA.appointmentstatus.name, completeStatusID);
                    res.properties.completiondate = new Date();
                    res.save(function (err) {
                        if (err)
                            MobileCRM.bridge.alert(err);
                        else
                            fetchListEntityData();
                    });
                }, MobileCRM.bridge.alert);
            }, MobileCRM.bridge.alert);
        }
        function fetchCompleteStatus() {
            var deferred = $.Deferred();

            var entity = new MobileCRM.FetchXml.Entity(SCHEMA.appointmentstatus.name);
            entity.addAttribute(SCHEMA.appointmentstatus.Properties.id);
            entity.addFilter().where(SCHEMA.appointmentstatus.Properties.name, 'eq', 'COMPLETE');

            var fetch = new MobileCRM.FetchXml.Fetch(entity);
            fetch.execute("JSON", function (res) {
                if (res[0])
                    return deferred.resolve(res[0].id);
                else
                    return deferred.reject("Unable to load Complete Status");
            }, function (err) { return deferred.reject(err); });
            return deferred.promise();
        }

        function timeIn() {
            if (selected[entityName].name.toUpperCase().indexOf("PENDING") > -1) {
                sayLocalization("Alert.SyncCompleteAppointment");
                return;
            }
            else if (setupOptions.UseJobSafetyTasks && setupOptions.JobSafetyUnsafeStatus && selected[entityName].appointmentstatusid &&
                selected[entityName].appointmentstatusid.primaryName.indexOf(setupOptions.JobSafetyUnsafeStatus) > -1) {
                sayLocalization("Alert.AppointmentStatusUnsafe");
                return;
            }

            var target = new MobileCRM.Reference(entityName, selected[entityName].id);
            var relationship = new MobileCRM.Relationship(SCHEMA.timelog.Properties.appointmentid, target);

            if (!setupOptions.TimeLogAllowTimeOverlap)
                checkForTimeOverlap().then(function (overlapAppt) {
                    if (overlapAppt) {
                        var msg = MobileCRM.Localization.get("Alert.TimeLogOverlapNotAllowed").format(overlapAppt);
                        MobileCRM.UI.MessageBox.sayText(msg, function () { });
                    }
                    else
                        MobileCRM.UI.FormManager.showEditDialog(SCHEMA.timelog.name, null, relationship);
                }, MobileCRM.bridge.alert);
            else
                MobileCRM.UI.FormManager.showEditDialog(SCHEMA.timelog.name, null, relationship);
        }
        function timeOut() {
            MobileCRM.UI.FormManager.showEditDialog(SCHEMA.timelog.name, selected.timelog.id);
        }
        function checkForTimeOverlap() {
            var deferred = $.Deferred();

            var entity = new MobileCRM.FetchXml.Entity(SCHEMA.timelog.name);
            entity.addAttribute(SCHEMA.timelog.Properties.appointmentid);

            entity.addFilter().where(SCHEMA.timelog.Properties.appointmentid, 'ne', selected[entityName].id);
            entity.addFilter().where(SCHEMA.timelog.Properties.gptimein, 'not-null');
            entity.addFilter().where(SCHEMA.timelog.Properties.gptimeout, 'null');
            entity.filter.type = 'and';

            var fetch = new MobileCRM.FetchXml.Fetch(entity);
            fetch.execute("JSON", function (res) {
                return deferred.resolve(res[0] ? res[0].appointmentid.primaryName : null);
            }, function (err) { return deferred.reject(err); });
            return deferred.promise();
        }
        function checkOpenTimeLog() {
            var deferred = $.Deferred();

            var entity = new MobileCRM.FetchXml.Entity(SCHEMA.timelog.name);
            entity.addAttribute(SCHEMA.timelog.Properties.id);

            entity.addFilter().where(SCHEMA.timelog.Properties.appointmentid, 'eq', selected[entityName].id);
            entity.addFilter().where(SCHEMA.timelog.Properties.gptimein, 'not-null');
            entity.addFilter().where(SCHEMA.timelog.Properties.gptimeout, 'null');
            entity.filter.type = 'and';

            var fetch = new MobileCRM.FetchXml.Fetch(entity);
            fetch.execute("JSON", function (res) {
                return deferred.resolve(res.length > 0);
            }, function (err) { return deferred.reject(err); });
            return deferred.promise();
        }
        function checkForLaborExpense() {
            var deferred = $.Deferred();

            var entity = new MobileCRM.FetchXml.Entity(SCHEMA.laborexpense.name);
            entity.addAttribute(SCHEMA.laborexpense.Properties.id);
            entity.addFilter().where(SCHEMA.laborexpense.Properties.appointmentid, 'eq', selected[entityName].id);

            var fetch = new MobileCRM.FetchXml.Fetch(entity);
            fetch.execute("JSON", function (res) {
                return deferred.resolve(res.length > 0);
            }, function (err) { return deferred.reject(err); });
            return deferred.promise();
        }

        // ----- MOBILE AUDIT BACKGROUND SYNC -----
        function mobileAuditBackgroundSync(entity) {
            var entityProps = entity.properties;
            var backgroundSync = false;

            if (entity.entityName === SCHEMA.appointment.name)
                backgroundSync = entityProps.appointmentstatusid.primaryName === setupOptions.OnSiteStatusUpdate;
            if (entity.entityName === SCHEMA.timelog.name)
                backgroundSync = typeof setupOptions.TimeLogStatusUpdate !== 'undefined';

            fetchMobileAudits().then(function (mobileAudits) {
                getTechnicianID(function (tech) {
                    var auditName = entityProps.gpservicecallid ? entityProps.gpservicecallid : entityProps.gpjobnumber;
                    auditName += ":" + entityProps.gpappointmentid + ":" + tech + ":";

                    if (entityProps.appointmentid) { // timelog entity
                        MobileCRM.DynamicEntity.loadById(entityName, entityProps.appointmentid.id, function (appt) {
                            auditName += appt.properties.gpappointmenttype + ":" + appt.properties.appointmentstatusid.primaryName;
                            updateMobileAuditDescription(mobileAudits, auditName, tech, backgroundSync);
                        }, MobileCRM.bridge.log);
                    }
                    else {
                        auditName += entityProps.gpappointmenttype + ":" + entityProps.appointmentstatusid;
                        updateMobileAuditDescription(mobileAudits, auditName, tech, backgroundSync);
                    }
                });

            }, function (err) {
                if (~err.toUpperCase().indexOf("ENTITY NOT FOUND"))
                    sayLocalization("Alert.AuditingNotEnabled");
                else MobileCRM.bridge.log(err);
            });
        }
        function fetchMobileAudits() {
            var deferred = $.Deferred();

            var entity = new MobileCRM.FetchXml.Entity(SCHEMA.resco_mobileaudit.name);
            entity.addAttributes();

            var fetch = new MobileCRM.FetchXml.Fetch(entity);
            fetch.execute("DynamicEntities",
                function (res) { return deferred.resolve(res); },
                function (err) { return deferred.reject(err); }
            );
            return deferred.promise();
        }
        function updateMobileAuditDescription(mobileAudits, auditName, tech, sync) {
            $.each(mobileAudits, function (i, item) {
                if (!item.properties.resco_description) {
                    item.properties.resco_description = item.properties.resco_entityid ? auditName : tech;
                    item.save(
                        function (err) {
                            if (err) MobileCRM.bridge.log(err);
                            else if (sync) saveOnline(this);
                        }
                    );
                }
                else if (sync)
                    saveOnline(item);
            });
        }
        function saveOnline(mobileAudit) {
            var props = mobileAudit.properties;
            if (props._privVals) props = props._privVals;
            var request = {
                entity: SCHEMA.resco_mobileaudit.name, id: mobileAudit.id, properties: props,
                isNew: true, isOnline: true, isOnlineForce: true
            };
            var cmdParams = JSON.stringify(request);

            connectionCheck(function () {
                window.MobileCRM.bridge.command('entitysave', cmdParams,
                    function (result) {
                        mobileAudit.id = result.id;
                        mobileAudit.isNew = false;
                        mobileAudit.isOnline = result.isOnline;
                        mobileAudit.primaryName = result.primaryName;
                        mobileAudit.properties = result.properties;

                        MobileCRM.DynamicEntity.deleteById(SCHEMA.resco_mobileaudit.name, mobileAudit.id,
                            function () { }, MobileCRM.bridge.log);
                    },
                    MobileCRM.bridge.log, this);
            });
        }

        // --- MOBILE AUDIT BACKGROUND SYNC: CONNECTION STATUS ---
        function noConnection(connectionType) {
            MobileCRM.bridge.log("MobileAudit upload sync failed: No " + connectionType + " Connection.");
        }
        function connectionCheck(success) {
            if (!navigator.onLine) noConnection("Internet");
            else {
                var networkCheck = new MobileCRM.FetchXml.Entity(SCHEMA.setupoption.name);
                networkCheck.addAttribute(SCHEMA.setupoption.Properties.name);
                var networkFetch = new MobileCRM.FetchXml.Fetch(networkCheck);
                networkFetch.execute("Online.JSON",
                    success,
                    function (err) {
                        if (~err.toUpperCase().indexOf("CAN'T CONNECT") || ~err.indexOf("500"))
                            noConnection("Server");
                        else
                            MobileCRM.bridge.log(err);
                    }, null);
            }
        }
    </script>
</body>
</html>